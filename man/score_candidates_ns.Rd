% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/register_rank_endpoint.R
\name{score_candidates_ns}
\alias{score_candidates_ns}
\title{Rank non-streaming JSON paths for answer/think (segment-aware, conflict-guarded)}
\usage{
score_candidates_ns(
  obj,
  lexicon = default_keyword_lexicon(),
  prob_thresh = list(answer = 0.6, think = 0.55),
  top_k = 10
)
}
\arguments{
\item{obj}{A parsed JSON object (list) representing a non-streaming response.}

\item{lexicon}{A keyword lexicon list (see \code{default_keyword_lexicon()}),
containing \code{$ns$answer}, \code{$ns$think}, and a global \code{$blacklist}.}

\item{prob_thresh}{Named list with numeric thresholds in \code{[0, 1]} for
selection: \code{list(answer = 0.60, think = 0.55)} by default. If the top
probability for a side is below its threshold, that side is returned as \code{NULL}.}

\item{top_k}{Integer. Number of top ranked candidate rows to keep in the
\code{candidates} data frame (after sorting by the max of the two scores).}
}
\value{
A list with:
\describe{
  \item{\code{best}}{A list with two entries \code{answer} and \code{think},
    each either \code{NULL} or a list: \code{list(path, key, text, prob, score)}.
    If both winners point to the same path, the \code{think} winner is suppressed
    (set to \code{NULL}) to avoid duplication.}
  \item{\code{candidates}}{A data frame of up to \code{top_k} rows with columns:
    \code{path}, \code{key}, \code{value}, \code{hits_answer}, \code{hits_think},
    \code{len_norm}, \code{len_clip}, \code{path_boost_ans}, \code{path_boost_think},
    \code{conflict_reason}, \code{score_ns_answer}, \code{score_ns_think},
    \code{prob_ns_answer}, \code{prob_ns_think}, \code{excerpt}, \code{rank_key}.}
}
}
\description{
Given a parsed **non-streaming** LLM JSON response, this function scores every
leaf node and returns the most probable **answer** and **think** fields.
The scorer:
\itemize{
  \item flattens the JSON into \code{(path, key, value)} rows;
  \item counts \emph{segment-exact} matches against \code{lexicon$ns$answer}
        and \code{lexicon$ns$think};
  \item applies path boosts (e.g., \code{choices/message/content/text} → answer;
        \code{reasoning/thinking/analysis} → think);
  \item penalizes answer picks found under reasoning-like segments;
  \item length-normalizes and clipped-length scores;
  \item softmax-normalizes to probabilities and selects tops above thresholds.
}
}
\details{
The scoring uses segment-level token hits (no substring matching) plus path-based
boosts and conflict penalties. Probabilities are produced via a softmax over
the respective score vectors (\code{answer} and \code{think}) independently.
Thresholds gate the final picks. See also \code{score_candidates_st()} for
streaming (SSE) candidates ranking.
}
\section{Conflicts & thresholds}{

If both best indices resolve to the same \code{path}, \code{think} is suppressed.
Any side whose top probability is below its threshold is returned as \code{NULL}.
}

\seealso{
\code{\link{score_candidates_st}}, \code{\link{flatten_json_paths}},
  \code{\link{default_keyword_lexicon}}
}
