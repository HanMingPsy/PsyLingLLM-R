% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/factorial_trial_experiment.R
\name{factorial_trial_experiment}
\alias{factorial_trial_experiment}
\title{Run Factorial Trial Experiment (registry-driven, assistant-native)}
\usage{
factorial_trial_experiment(
  model_key,
  generation_interface = "chat",
  api_key,
  api_url = NULL,
  data,
  factors,
  CW = NULL,
  fill_method = NULL,
  trial_prompt = NULL,
  system_content = NULL,
  assistant_content = NULL,
  optionals = NULL,
  role_mapping = NULL,
  stream = NULL,
  timeout = getOption("psylingllm.llm_timeout_sec", 120L),
  repeats = 1,
  random = FALSE,
  delay = 0,
  output_path = NULL,
  overwrite = TRUE,
  return_raw = FALSE
)
}
\arguments{
\item{model_key}{Character(1). Registry key (e.g., \code{"deepseek-chat"} or \code{"deepseek-chat@proxy"}).}

\item{generation_interface}{Character(1). Interface name; default \code{"chat"}.}

\item{api_key}{Character(1). Provider API key.}

\item{api_url}{Optional character(1). Overrides registry default URL; required for non-official providers.}

\item{data}{A \code{data.frame} or a file path accepted by
\code{generate_llm_factorial_experiment_list()}. Must contain at least
\code{Material} (carrier). If using CW, also provide \code{CW} or \code{Word}.}

\item{factors}{A named list of factors, e.g.,
\code{list(Congruity = c("Congruent", "Incongruent"))}.}

\item{CW}{Optional \code{data.frame} with \code{Item} plus columns named by
factor-level combinations in wide format.}

\item{fill_method}{Optional function to build the per-row stimulus (see "Stimulus construction").}

\item{trial_prompt}{Optional character(1). Global trial prefix; row-level \code{TrialPrompt}
(if present) takes precedence.}

\item{system_content}{Optional character(1) or \code{NULL}. If \code{NULL},
registry \code{default_system} is used when available.}

\item{assistant_content}{Optional static few-shot seed: a character vector or a list of
message objects (\code{list(role = ..., content = ...)}). These appear before
rolling history and are preserved as-is.}

\item{optionals}{Optional named list. If not supplied, defaults are used (tri-state);
if \code{NULL}, no defaults are injected; if a list, only user keys are sent.}

\item{role_mapping}{Optional mapping of roles (\code{system}/\code{user}/\code{assistant}).
If absent, registry mapping applies.}

\item{stream}{Logical(1) or \code{NULL}. If \code{NULL}, uses the registry default;
otherwise forces streaming/non-streaming.}

\item{timeout}{Integer(1). Per-request timeout in seconds (passed to \code{llm_caller()}).}

\item{repeats}{Integer(1). Number of repetitions per factorial row.}

\item{random}{Logical(1). Randomize trial order.}

\item{delay}{Numeric(1). Delay (seconds) between trials.}

\item{output_path}{Character or \code{NULL}. Path to save results/logs
(same behavior as \code{trial_experiment()}).}

\item{overwrite}{Logical(1). Overwrite existing outputs.}

\item{return_raw}{Logical(1). Include raw request/response for debugging.}
}
\value{
A \code{data.frame} (or tibble) with PsyLingLLM schema columns per trial:
  \code{Response}, \code{Think}, \code{ModelName}, \code{TotalResponseTime},
  \code{FirstTokenLatency}, \code{PromptTokens}, \code{CompletionTokens},
  \code{TrialStatus}, \code{Streaming}, \code{Timestamp}, \code{RequestID},
  plus \code{Stimulus} and \code{ConditionLabel}.
}
\description{
Builds a factorial trial list (carrier sentences × factor levels × optional CW),
constructs a stimulus for each row (via `fill_method` or sensible defaults),
and calls \code{llm_caller()} for each trial using the package registry
(no manual headers/body here).
}
\details{
The trial list is generated by \code{generate_llm_factorial_experiment_list()},
which yields columns such as \code{Run}, \code{Item}, \code{Material} (carrier),
\code{Word} (CW), factor columns, and optionally \code{TrialPrompt}.
This function then produces a per-row user message (stimulus) and executes the trials.

## Stimulus construction
- If \code{fill_method} is provided, it is called as:
  \preformatted{
  fill_method(
    condition = list(<Factor> = <Level>, ...),
    material  = <carrier sentence>,
    word      = <CW string or NA>
  )
  }

- If \code{fill_method} is \code{NULL}, defaults to:
  1) Replace the first occurrence of one of the placeholders
     \code{"\\{CW\\}"}, \code{"[CW]"}, \code{"__CW__"}, or \code{"____"}
     in \code{Material} with \code{Word} (if non-NA);
  2) Otherwise, \code{paste(Material, Word)} if a CW word exists;
  3) Otherwise, just \code{Material}.

## Error & timeout handling
- Timeout inside \code{llm_caller()} returns \code{status = 599} → \code{TrialStatus = "TIMEOUT"} (continue).
- HTTP error (\code{status >= 400}) → \code{TrialStatus = "ERROR"} (continue).
}
